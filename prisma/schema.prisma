// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
}

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

enum SupplierType {
  FABRIC_MILL
  DYE_HOUSE
  GARMENT_FACTORY
  TRIM_SUPPLIER
  OTHER
}

enum CertificationType {
  GOTS
  OEKO_TEX
  SA8000
  BSCI
  FAIR_WEAR
  ISO14001
  OTHER
}

enum CertificationStatus {
  VALID
  EXPIRING_SOON
  EXPIRED
}

enum AlertType {
  NINETY_DAY
  THIRTY_DAY
  SEVEN_DAY
  EXPIRED
}

enum VerificationStatus {
  UNVERIFIED
  BASIC
  VERIFIED
  FAILED
  PENDING
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum VerificationMethod {
  MANUAL
  API
  WEB_SCRAPING
  LIST_MATCHING
}

// Models
model Brand {
  id                String           @id @default(cuid())
  clerk_user_id     String           @unique
  company_name      String
  email             String           @unique
  country           String?
  subscription_tier SubscriptionTier @default(FREE)
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt

  // Gmail OAuth integration
  gmail_refresh_token String?
  gmail_token_expiry  DateTime?
  gmail_connected_at  DateTime?

  // Relations
  suppliers       Supplier[]
  users           User[]
  alerts          Alert[]
  emailImports    EmailImport[]
  gmailWatchState GmailWatchState?

  @@index([clerk_user_id])
  @@index([email])
  @@map("brands")
}

model User {
  id            String   @id @default(cuid())
  clerk_user_id String   @unique
  brand_id      String
  email         String   @unique
  full_name     String
  role          UserRole @default(VIEWER)
  created_at    DateTime @default(now())

  // Relations
  brand Brand @relation(fields: [brand_id], references: [id], onDelete: Cascade)

  @@index([clerk_user_id])
  @@index([brand_id])
  @@index([email])
  @@map("users")
}

model Supplier {
  id                  String             @id @default(cuid())
  brand_id            String
  name                String
  contact_email       String?
  contact_phone       String?
  country             String
  address             String?
  supplier_type       SupplierType
  verification_status VerificationStatus @default(UNVERIFIED)
  verified_at         DateTime?
  verified_by         String?
  created_at          DateTime           @default(now())
  updated_at          DateTime           @updatedAt

  // Relations
  brand          Brand           @relation(fields: [brand_id], references: [id], onDelete: Cascade)
  certifications Certification[]

  @@index([brand_id])
  @@index([name])
  @@index([country])
  @@index([supplier_type])
  @@index([verification_status])
  @@map("suppliers")
}

model Certification {
  id                 String              @id @default(cuid())
  supplier_id        String
  certification_type CertificationType
  certification_name String
  certificate_number String?
  issuing_body       String
  issue_date         DateTime
  expiry_date        DateTime
  document_url       String
  document_hash      String? // For deduplication
  status             CertificationStatus @default(VALID)

  // OCR/NLP extracted data
  extracted_data        Json? // Store raw extracted data
  extraction_confidence Float? // Confidence score 0-1
  needs_review          Boolean @default(false)

  // Verification fields
  verification_status     VerificationStatus  @default(UNVERIFIED)
  verification_method     VerificationMethod?
  verification_confidence Float? // Confidence score 0-1
  verification_date       DateTime?
  verification_details    Json? // Additional verification metadata
  last_verified_at        DateTime?

  // Import tracking
  email_import_id String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  supplier    Supplier     @relation(fields: [supplier_id], references: [id], onDelete: Cascade)
  alerts      Alert[]
  emailImport EmailImport? @relation(fields: [email_import_id], references: [id])

  @@index([supplier_id])
  @@index([expiry_date])
  @@index([status])
  @@index([created_at])
  @@index([certification_type])
  @@index([verification_status])
  @@index([needs_review])
  @@index([document_hash])
  @@index([email_import_id])
  @@map("certifications")
}

model Alert {
  id               String    @id @default(cuid())
  certification_id String
  brand_id         String
  alert_type       AlertType
  sent_at          DateTime?
  is_read          Boolean   @default(false)
  created_at       DateTime  @default(now())

  // Relations
  certification Certification @relation(fields: [certification_id], references: [id], onDelete: Cascade)
  brand         Brand         @relation(fields: [brand_id], references: [id], onDelete: Cascade)

  @@index([brand_id, is_read])
  @@index([certification_id])
  @@index([created_at])
  @@index([alert_type])
  @@map("alerts")
}

// Email import tracking
model EmailImport {
  id               String       @id @default(cuid())
  brand_id         String
  gmail_message_id String       @unique
  sender_email     String
  sender_name      String?
  subject          String?
  received_date    DateTime
  attachment_count Int          @default(0)
  status           ImportStatus @default(PENDING)
  error_message    String?
  processed_at     DateTime?
  created_at       DateTime     @default(now())

  // Relations
  brand          Brand           @relation(fields: [brand_id], references: [id], onDelete: Cascade)
  certifications Certification[]

  @@index([brand_id])
  @@index([status])
  @@index([created_at])
  @@index([gmail_message_id])
  @@map("email_imports")
}

// Gmail API watch state for push notifications
model GmailWatchState {
  id         String   @id @default(cuid())
  brand_id   String   @unique
  history_id String? // Last processed history ID
  expiration DateTime // When the watch expires
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  brand Brand @relation(fields: [brand_id], references: [id], onDelete: Cascade)

  @@map("gmail_watch_states")
}
